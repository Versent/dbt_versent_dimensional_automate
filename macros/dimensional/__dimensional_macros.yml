version: 2

macros:
  - name: fact
    description: >
      This macro generates the sql to create a fact table. It takes the source and looks up the dimensions based on the hk's provided.
    arguments:
      - name: hash_key
        type: binary
        description: the hash key
      - name: source
        type: string
        description: Source model for the fact, typically a bridge model in silver business datavault
      - name: as_at_date
        type: date
        description: >
          If provided will be used to lookup dimensional keys based on it being between the effective_from and effective_to_dates
      - name: payload
        type: array
        description: A list of attributes to be included in the fact. These can include measures and degenerate dimensions
      - name: type1_dimensions
        type: array
        description: A list of dimensions where a point in time is not required. Join is on the hk of the dimensions
      - name: type2_dimensions
        type: array
        description: >
          A list of dimensions where the sid is at a point on time. The join is calculated for the date of the fact, where is is between the 
          effective_from_date and effective_to_date.

          Refer https://www.kimballgroup.com/data-warehouse-business-intelligence-resources/kimball-techniques/dimensional-modeling-techniques/type-2/
      - name: role_playing_dimensions
        type: array - dictionary 
        description: >
          A dictionary of dimensions for role playing dimensions, we use this when the dimension has already been used in the fact.
          The dicitonary has sub elements i.e.
              - dim_work_order_project: 
                  dim:    dim_project
                  hk:     hk_Work_Order_Project
                  type: 2

          In this case , dim_work_order_project is the name of the role playing dimension and its sid
          * dim: is the physical name of the dimension to use for the lookup
          * hk: is the name of the join column to use
          * type: either 1 or 2, if 2 then the macro generates a date between effective from and to clause

  - name: dim_type1
    description: >
      Has no effective dates or is_current flags. Something that cannot change over time e.g. dim_date
    arguments:
      - name: hash_key
        type: binary
        description: the hash key
      - name: source
        type: text
        description: Source model for the dimension, typically a cbc model in silver business datavault
      - name: payload
        type: array
        description: A list of attributes to be included in the dimension.
  - name: dim
    description: >
      Macro generates the type 2 dimension, include effective from and to dates, uses the record action to determin is_deleted flags.

      This macro assumes the presence of hk_date to join to dim_date. From which it gets the date for the comparison for effective_from and effective_to flags.
    arguments:
      - name: hash_key
        type: binary
        description: the hash key
      - name: source
        type: text
        description: Source model for the dimension, typically a cbc model in silver business datavault
      - name: payload
        type: array
        description: A list of attributes to be included in the dimension.
      - name: record_action
        type: text
        description: If 'DELETE' then is_deleted is set to Y
  - name: eim_view
    description: >
      Turns binary fields into strings so that Power BI can use them in the joins. Why Power BI cant use binary
      columns for joins is quite another question. 
    arguments:
        - name: source
          type: text
          description: Source model for the dimension, typically a cbc model in silver business datavault
        - name: hks_to_string
          type: array
          description: >
            A list of hash keys to convert to string